<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navbar -->
    <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-900">Manager Dashboard</h1>
            <div class="flex items-center space-x-4">
                <span id="welcome-message" class="text-gray-600"></span>
                <button id="logout-button" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0 space-y-8">
            
            <!-- Manager Info and Project Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Your Information</h2>
                <div id="manager-info" class="text-gray-600">
                    <p><strong>Name:</strong> <span id="manager-name"></span></p>
                    <p><strong>Email:</strong> <span id="manager-email"></span></p>
                    <p><strong>Assigned Site:</strong> <span id="manager-site-name" class="font-semibold"></span></p>
                </div>
            </div>

            <!-- Expense Submission Form -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Submit Daily Expense</h2>
                <div id="message-box" class="hidden p-3 mb-4 rounded-lg text-sm bg-red-100 text-red-700" role="alert"></div>

                <form id="expense-form" class="space-y-4">
                    <div>
                        <label for="expense-date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="expense-date" name="expense-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="expense-description" class="block text-sm font-medium text-gray-700">Description (e.g., fuel, materials)</label>
                        <input type="text" id="expense-description" name="expense-description" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="expense-amount" class="block text-sm font-medium text-gray-700">Amount ($)</label>
                        <input type="number" id="expense-amount" name="expense-amount" required step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Submit Expense
                        </button>
                    </div>
                </form>
            </div>

            <!-- Expense History Table -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Your Expense History</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Expense rows will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { firebaseConfig } from "./firebase_config.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Elements
        const welcomeMessage = document.getElementById('welcome-message');
        const logoutButton = document.getElementById('logout-button');
        const expenseForm = document.getElementById('expense-form');
        const expensesTableBody = document.getElementById('expenses-table-body');
        const messageBox = document.getElementById('message-box');
        const managerNameSpan = document.getElementById('manager-name');
        const managerEmailSpan = document.getElementById('manager-email');
        const managerSiteNameSpan = document.getElementById('manager-site-name');

        let currentUserId = null;

        // Function to show messages
        const showMessage = (text, type = 'error') => {
            messageBox.textContent = text;
            messageBox.className = `p-3 mb-4 rounded-lg text-sm ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            messageBox.classList.remove('hidden');
        };

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                // Check user's role and fetch their data
                const userDocRef = doc(db, 'users', currentUserId);
                onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().role === 'manager') {
                        const userData = docSnap.data();
                        welcomeMessage.textContent = `Welcome, ${userData.name}!`;
                        managerNameSpan.textContent = userData.name || 'N/A';
                        managerEmailSpan.textContent = userData.email || 'N/A';
                        managerSiteNameSpan.textContent = userData.siteName || 'Not Assigned';
                        fetchDailyExpenses(currentUserId);
                    } else {
                        // If not a manager or user data is missing, redirect to login
                        window.location.href = 'index.html';
                    }
                });
            } else {
                // No user is signed in, redirect to login page
                window.location.href = 'index.html';
            }
        });

        // Submit new expense
        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = expenseForm['expense-date'].value;
            const description = expenseForm['expense-description'].value;
            const amount = parseFloat(expenseForm['expense-amount'].value);

            if (!date || !description || isNaN(amount) || amount <= 0) {
                showMessage("Please fill in all fields with valid data.");
                return;
            }

            try {
                // Add the new expense to Firestore
                await addDoc(collection(db, 'expenses'), {
                    date: date,
                    description: description,
                    amount: amount,
                    managerId: currentUserId
                });

                showMessage("Expense submitted successfully!", 'success');
                expenseForm.reset(); // Clear the form
            } catch (error) {
                console.error("Error submitting expense:", error);
                showMessage("Failed to submit expense. Please try again.");
            }
        });

        // Fetch and display daily expenses for the logged-in manager
        const fetchDailyExpenses = (managerId) => {
            const expensesQuery = query(collection(db, 'expenses'), where('managerId', '==', managerId));
            onSnapshot(expensesQuery, (querySnapshot) => {
                expensesTableBody.innerHTML = ''; // Clear previous data
                const expenses = [];

                querySnapshot.forEach(doc => {
                    const expense = doc.data();
                    expenses.push({
                        date: expense.date,
                        description: expense.description,
                        amount: expense.amount
                    });
                });

                // Sort expenses by date in descending order (most recent first)
                expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (expenses.length === 0) {
                    expensesTableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No expenses found.</td></tr>`;
                } else {
                    expenses.forEach(expense => {
                        const rowHtml = `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${expense.date}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${expense.description}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">$${expense.amount.toFixed(2)}</td>
                            </tr>
                        `;
                        expensesTableBody.innerHTML += rowHtml;
                    });
                }
            });
        };

        // Logout functionality
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'index.html'; // Redirect to login page
            } catch (error) {
                console.error("Logout failed:", error);
                showMessage('An error occurred during logout. Please try again.');
            }
        });
    </script>
</body>
</html>
